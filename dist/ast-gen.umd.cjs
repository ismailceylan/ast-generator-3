(function(o,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(o=typeof globalThis<"u"?globalThis:o||self,c(o["ast-gen"]={}))})(this,function(o){"use strict";var B=Object.defineProperty;var P=(o,c,l)=>c in o?B(o,c,{enumerable:!0,configurable:!0,writable:!0,value:l}):o[c]=l;var u=(o,c,l)=>P(o,typeof c!="symbol"?c+"":c,l);const c=Symbol("newline"),l=Symbol("blank");class b{constructor(e,t="",n=1,s=1,r=1){u(this,"name");u(this,"value");u(this,"line");u(this,"start");u(this,"end");this.name=e,this.value=t,this.line=n,this.start=s,this.end=r}get length(){return this.value.length}}class N extends Array{get first(){return this[0]}get latest(){return this[this.length-1]}pushToLatestNode(e,t){const n=e.split(`
`).length-1;let s=this[this.length-1];return s?s.name!==t?this.push(s=new b(t,e,s.line,s.start+1,(e||"").length)):s.name===t&&(s.value+=e,s.end+=e.length,n>0&&(s.line+=n)):this.push(s=new b(t,e,void 0,void 0,(e||"").length)),s}push(e){const t=this[this.length-1];return t&&(e.start=t.end+1,e.end=e.start+e.value.length-1,e.line=t.line+e.value.split(`
`).length-1),super.push(e)}toString(){return this.map(e=>e.value).join("")}}var C=Object.defineProperty,I=(i,e,t)=>e in i?C(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,d=(i,e,t)=>I(i,typeof e!="symbol"?e+"":e,t);class L{constructor(e){d(this,"BEGINNING",Symbol("beginning")),d(this,"ENDING",Symbol("ending")),d(this,"raw",""),d(this,"cursor",0),this.raw=e}get current(){return this.raw[this.cursor]}get next(){return this.raw[++this.cursor]}get prev(){return this.raw[--this.cursor]}matches(e){return this.raw.slice(this.cursor,this.cursor+e.length)===e}before(e){return this.raw.slice(this.cursor-e.length,this.cursor)===e}after(e){return this.raw.slice(this.cursor+1,this.cursor+e.length+1)===e}distanceTo(e){const t=e===this.BEGINNING?this.cursor:e===this.ENDING?this.raw.length-this.cursor-1:this.raw.indexOf(e,this.cursor)-this.cursor-1;return t<0?1/0:t}closest(e){return e.map(t=>[t,this.distanceTo(t)]).sort((t,n)=>t[1]-n[1])}startTransaction(){const{cursor:e}=this;function t(){this.cursor=e}return t.bind(this)}getUntil(e){const t=this.raw.indexOf(e,this.cursor);if(t===-1)return;const n=this.raw.slice(this.cursor,t);return this.cursor+=n.length,n}slice(e){if(e<0)throw new RangeError(`Cannot slice backwards from ${this.cursor} to ${e}.`);const t=this.raw.slice(this.cursor,this.cursor+e);return this.cursor=e===1/0?this.raw.length:this.cursor+e,t}move(e){return this.cursor+=e,this}moveTo(e){return this.cursor=e,this}jumpTo(e){return this.cursor=this.raw.indexOf(e,this.cursor)}consume(e){let t;const n=this.cursor;for(Array.isArray(e)||(e=[e]);(t=e.findIndex(s=>this.matches(s)))>-1;)this.move(e[t].length);return this.raw.slice(n,this.cursor)}}function E(i,e,{mergeTokens:t=!1}={}){const n=new N,s=new L(i);do{let r;e:for(let[h,g,{merge:y}={}]of e){let T=t;typeof g=="string"&&(g=[g]),y!==void 0&&(T=y);for(const m of g)if(s.matches(m)){T?r=n.pushToLatestNode(m,h):(r=new b,r.name=h,r.value=m,r.end=s.cursor+m.length,n.push(r)),s.cursor+=m.length-1;break e}}r||n.pushToLatestNode(s.current,l)}while(s.next!==void 0);return n}class q{constructor({components:e,tokenization:t}){u(this,"components",[]);u(this,"tokenization",{});this.components=e,this.tokenization=t}parse(e){const t=E(e,this.tokenization.rules,this.tokenization.merge),n=new w(t),s=[];do{for(const r of this.components){const h=r.run({stream:n});if(h!==a){s.push(h);break}}n.current&&s.push(n.current),n.moveNext()}while(n.current!==void 0);return s}}class k{constructor(e,t=[]){u(this,"name");u(this,"sequences");this.name=e,this.sequences=t;for(const[n,s]of this.sequences.entries())s.component=this,s.index=n}run({stream:e}){if(e.current===void 0)return a;const t=new v(this),n=e.startTransaction(),s=new p(this.name);s.start=e.current.start,s.startLine=e.current.line,s.end=e.current.end,s.endLine=e.current.line;for(const r of this.sequences){if(r.run({stream:e,scope:t,astNode:s})===a)return n(),a;s.end=e.prev.end,s.endLine=e.prev.line}return s}}class f{constructor(e,t){u(this,"name");u(this,"component");u(this,"handler");u(this,"match");u(this,"movesCursor",!1);u(this,"scopeName");u(this,"subComponents",[]);u(this,"index");u(this,"minVal");this.name=e,this.handler=t}run({stream:e,scope:t,astNode:n}){const s=this.handler.call(this,{stream:e,scope:t,astNode:n});return this.subComponents.length>0&&this.parseSubComponents({scope:t,astNode:n}),s}moveCursor(){return this.movesCursor=!0,this}as(e){return this.scopeName=e,this}parse(e){return this.subComponents=e,this}parseSubComponents({scope:e,astNode:t}){if(!this.scopeName)throw new Error(`sequence.as() must be called when using sequence.parse() for ${this.index+1}. sequence "${this.component.name}.${this.name}"`);const n=e.scope[this.scopeName],s=new w(n);if(s.current!==void 0)for(const r of this.subComponents){const h=r.run({stream:s});h!==a&&Object.assign(t[this.scopeName],h.getSubNodes())}}min(e){return this.minVal=e,this}}class w{constructor(e){u(this,"tokens");u(this,"cursor",0);this.tokens=e}moveNext(){return this.tokens[++this.cursor]}movePrev(){return this.tokens[--this.cursor]}get next(){return this.tokens[this.cursor+1]}get prev(){return this.tokens[this.cursor-1]}get current(){return this.tokens[this.cursor]}match(e){Array.isArray(e)||(e=[e]);const t=this.tokens.slice(this.cursor,this.cursor+e.length);return t.every((s,r)=>{const h=e[r];if(typeof h=="symbol")return s.name===h;if(typeof h=="string"&&s.name===l)return s.value===h})?t.length===0?!1:t:!1}startTransaction(){const{cursor:e}=this;function t(){this.cursor=e}return t.bind(this)}consume(e){const t=new N,n=this.tokens.slice(this.cursor);let s;for(const r of n)if(r.name===e)this.cursor++,t.push(r);else{s=r;break}return[t,s]}until(e){const t=new N,n=this.tokens.slice(this.cursor);Array.isArray(e)||(e=[e]);e:for(const s of n)for(const r of e)if(s.name!==r){t.push(s),this.cursor++;continue e}else return[t,r]}}class v{constructor(e){u(this,"component");u(this,"scope",{});this.component=e}set(e,t){e.scopeName&&(this.scope[e.scopeName]=t)}}class p{constructor(e){u(this,"subNodeNames",[]);this.name=e}createSubNode(e,t){if(e===void 0)return;const n=this[e]=new p(e);return this.subNodeNames.push(e),n.tokens=t,n.start=t.first.start,n.end=t.latest.end,n.startLine=t.first.line,n.endLine=this.endLine=t.latest.line,n}getSubNodes(){const e={};return this.subNodeNames.forEach(t=>e[t]=this[t]),e}}function A(i,e){return new k(i,e)}const a=Symbol("failed"),S=Symbol("beginning");function G(i){return new f("match",function({stream:e,scope:t,astNode:n}){var r;let s;if(i===S){if(((r=e.prev)==null?void 0:r.name)===c)return this.match=!0,t.set(this,!0),!0}else if(s=e.match(i))return this.match=i,t.set(this,s),n.createSubNode(this.scopeName,s),this.movesCursor&&(e.cursor+=s.length),!0;return a})}function j(i){return new f("not",function({stream:e}){return e.match(i)?a:!0})}function O(i){const e=new f("until",function({stream:t,scope:n,astNode:s}){const r=t.until(i);return r===void 0?a:(this.match=r[1],n.set(this,r[0]),s.createSubNode(this.scopeName,r[0]),!0)});return e.movesCursor=!0,e}function z(i){const e=new f("consume",function({stream:t,scope:n,astNode:s}){const r=t.consume(i);return r[0].length===0||this.minVal!==void 0&&r[0].toString().length<this.minVal?a:(this.match=r[1],n.set(this,r[0]),s.createSubNode(this.scopeName,r[0]),!0)});return e.movesCursor=!0,e}o.ASTNode=p,o.BEGINNING=S,o.Component=k,o.FAILED=a,o.Parser=q,o.Scope=v,o.Sequence=f,o.TokenStream=w,o.component=A,o.consume=z,o.match=G,o.not=j,o.until=O,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
